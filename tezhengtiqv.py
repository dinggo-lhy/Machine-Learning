import pandas as pd
import numpy as np
from sklearn.decomposition import PCA#ä¸»æˆåˆ†åˆ†æï¼Œç”¨äºé™ç»´
from sklearn.feature_selection import SelectKBest, RFE, SelectFromModel#åŸºäºå•å˜é‡ç»Ÿè®¡æ£€éªŒé€‰æ‹©æœ€ä½³ç‰¹å¾ï¼Œé€’å½’ç‰¹å¾æ¶ˆé™¤ï¼ŒåŸºäºæ¨¡å‹çš„ç‰¹å¾é€‰æ‹©ã€‚
from sklearn.feature_selection import f_classif, mutual_info_classif#ç‰¹å¾é€‰æ‹©çš„ç»Ÿè®¡æ–¹æ³•
from sklearn.ensemble import RandomForestClassifier#éšæœºæ£®æ—åˆ†ç±»å™¨
from sklearn.preprocessing import StandardScaler#æ•°æ®æ ‡å‡†åŒ–
import os#å¤„ç†æ–‡ä»¶è·¯å¾„


# ====================== é…ç½®æ–‡ä»¶ ======================
class ç‰¹å¾å·¥ç¨‹é…ç½®:
    """é…ç½®ç‰¹å¾å·¥ç¨‹å‚æ•°"""

    def __init__(self):
        # ç‰¹å¾é€‰æ‹©æ–¹æ³• (å¯é€‰: 'kbest'è¿‡æ»¤å¼, 'rfe'åŒ…è£¹å¼, 'embedded'åµŒå…¥å¼)
        self.ç‰¹å¾é€‰æ‹©æ–¹æ³• = 'embedded'

        # ç‰¹å¾æå–æ–¹æ³• (å¯é€‰: 'pca'ä¸»æˆåˆ†åˆ†æ, None)
        self.ç‰¹å¾æå–æ–¹æ³• = 'pca'

        # è¾“å‡ºæ–‡ä»¶å
        self.è¾“å‡ºæ–‡ä»¶è·¯å¾„ = 'processed_features.csv'

        # ç‰¹å¾é€‰æ‹©å‚æ•°
        self.é€‰æ‹©ç‰¹å¾æ•° = 10  # é€‰æ‹©TopNç‰¹å¾
        self.éšæœºç§å­ = 42  # ç¡®ä¿ç»“æœå¯å¤ç°


# ====================== æ ¸å¿ƒåŠŸèƒ½ ======================
def æ‰§è¡Œç‰¹å¾å·¥ç¨‹(åŸå§‹ç‰¹å¾, æ ‡ç­¾, é…ç½®):
    """
    æ‰§è¡Œç‰¹å¾å·¥ç¨‹æµç¨‹
    :param åŸå§‹ç‰¹å¾: è¾“å…¥ç‰¹å¾çŸ©é˜µ (n_samples, n_features)
    :param æ ‡ç­¾: ç›®æ ‡æ ‡ç­¾å‘é‡ (n_samples,)
    :param é…ç½®: ç‰¹å¾å·¥ç¨‹é…ç½®å¯¹è±¡
    :return: å¤„ç†åçš„ç‰¹å¾çŸ©é˜µ
    """
    # 1. æ•°æ®æ ‡å‡†åŒ–
    æ ‡å‡†åŒ–å™¨ = StandardScaler()
    æ ‡å‡†ç‰¹å¾ = æ ‡å‡†åŒ–å™¨.fit_transform(åŸå§‹ç‰¹å¾)

    # 2. ç‰¹å¾é€‰æ‹©
    if é…ç½®.ç‰¹å¾é€‰æ‹©æ–¹æ³• == 'kbest':
        print(f"âœ… ä½¿ç”¨è¿‡æ»¤å¼ç‰¹å¾é€‰æ‹© (SelectKBest), é€‰æ‹©Top{é…ç½®.é€‰æ‹©ç‰¹å¾æ•°}ç‰¹å¾")
        é€‰æ‹©å™¨ = SelectKBest(score_func=f_classif, k=é…ç½®.é€‰æ‹©ç‰¹å¾æ•°)
        é€‰æ‹©åç‰¹å¾ = é€‰æ‹©å™¨.fit_transform(æ ‡å‡†ç‰¹å¾, æ ‡ç­¾)
        ç‰¹å¾æ©ç  = é€‰æ‹©å™¨.get_support()

    elif é…ç½®.ç‰¹å¾é€‰æ‹©æ–¹æ³• == 'rfe':
        print(f"âœ… ä½¿ç”¨åŒ…è£¹å¼ç‰¹å¾é€‰æ‹© (RFE), é€‰æ‹©Top{é…ç½®.é€‰æ‹©ç‰¹å¾æ•°}ç‰¹å¾")
        åŸºæ¨¡å‹ = RandomForestClassifier(n_estimators=100, random_state=é…ç½®.éšæœºç§å­)
        é€‰æ‹©å™¨ = RFE(estimator=åŸºæ¨¡å‹, n_features_to_select=é…ç½®.é€‰æ‹©ç‰¹å¾æ•°)
        é€‰æ‹©åç‰¹å¾ = é€‰æ‹©å™¨.fit_transform(æ ‡å‡†ç‰¹å¾, æ ‡ç­¾)
        ç‰¹å¾æ©ç  = é€‰æ‹©å™¨.get_support()

    elif é…ç½®.ç‰¹å¾é€‰æ‹©æ–¹æ³• == 'embedded':
        print(f"âœ… ä½¿ç”¨åµŒå…¥å¼ç‰¹å¾é€‰æ‹© (éšæœºæ£®æ—é‡è¦æ€§), é€‰æ‹©Top{é…ç½®.é€‰æ‹©ç‰¹å¾æ•°}ç‰¹å¾")
        åŸºæ¨¡å‹ = RandomForestClassifier(n_estimators=100, random_state=é…ç½®.éšæœºç§å­)
        åŸºæ¨¡å‹.fit(æ ‡å‡†ç‰¹å¾, æ ‡ç­¾)
        é€‰æ‹©å™¨ = SelectFromModel(åŸºæ¨¡å‹, max_features=é…ç½®.é€‰æ‹©ç‰¹å¾æ•°, threshold=-np.inf)
        é€‰æ‹©åç‰¹å¾ = é€‰æ‹©å™¨.fit_transform(æ ‡å‡†ç‰¹å¾, æ ‡ç­¾)
        ç‰¹å¾æ©ç  = é€‰æ‹©å™¨.get_support()
    else:
        print("âš ï¸ æœªå¯ç”¨ç‰¹å¾é€‰æ‹©ï¼Œä½¿ç”¨å…¨éƒ¨åŸå§‹ç‰¹å¾")
        é€‰æ‹©åç‰¹å¾ = æ ‡å‡†ç‰¹å¾
        ç‰¹å¾æ©ç  = np.ones(æ ‡å‡†ç‰¹å¾.shape[1], dtype=bool)

    # 3. ç‰¹å¾æå–
    if é…ç½®.ç‰¹å¾æå–æ–¹æ³• == 'pca':
        print(f"âœ… åº”ç”¨PCAç‰¹å¾æå–, é™ç»´è‡³{é…ç½®.é€‰æ‹©ç‰¹å¾æ•°}ä¸»æˆåˆ†")
        pca = PCA(n_components=é…ç½®.é€‰æ‹©ç‰¹å¾æ•°, random_state=é…ç½®.éšæœºç§å­)
        æœ€ç»ˆç‰¹å¾ = pca.fit_transform(é€‰æ‹©åç‰¹å¾)
        print(f"  ä¸»æˆåˆ†è§£é‡Šæ–¹å·®æ¯”: {np.sum(pca.explained_variance_ratio_):.2%}")
    else:
        æœ€ç»ˆç‰¹å¾ = é€‰æ‹©åç‰¹å¾

    return æœ€ç»ˆç‰¹å¾, ç‰¹å¾æ©ç 


# ====================== æ–‡ä»¶å¤„ç† ======================
def ä¿å­˜å¤„ç†ç»“æœ(å¤„ç†ç‰¹å¾, æ ‡ç­¾, ç‰¹å¾åç§°, æ–‡ä»¶è·¯å¾„):
    """
    ä¿å­˜å¤„ç†åçš„ç‰¹å¾åˆ°CSVæ–‡ä»¶
    :param å¤„ç†ç‰¹å¾: å¤„ç†åçš„ç‰¹å¾çŸ©é˜µ
    :param æ ‡ç­¾: ç›®æ ‡æ ‡ç­¾å‘é‡
    :param ç‰¹å¾åç§°: åŸå§‹ç‰¹å¾åç§°åˆ—è¡¨
    :param æ–‡ä»¶è·¯å¾„: è¾“å‡ºæ–‡ä»¶è·¯å¾„
    """
    # ç”Ÿæˆæ–°ç‰¹å¾åç§°
    if len(å¤„ç†ç‰¹å¾.shape) == 1:
        æ–°ç‰¹å¾å = ['Feature_1']
    else:
        æ–°ç‰¹å¾å = [f'Feature_{i + 1}' for i in range(å¤„ç†ç‰¹å¾.shape[1])]

    # åˆ›å»ºDataFrame
    ç»“æœæ•°æ® = pd.DataFrame(å¤„ç†ç‰¹å¾, columns=æ–°ç‰¹å¾å)
    ç»“æœæ•°æ®['Target'] = æ ‡ç­¾

    # ä¿å­˜æ–‡ä»¶
    ç»“æœæ•°æ®.to_csv(æ–‡ä»¶è·¯å¾„, index=False)
    print(f"  å·²ä¿å­˜å¤„ç†ç»“æœè‡³: {os.path.abspath(æ–‡ä»¶è·¯å¾„)}")
    print(f"  æ–°æ•°æ®é›†ç»´åº¦: {ç»“æœæ•°æ®.shape}")


# ====================== ä¸»ç¨‹åº ======================
if __name__ == "__main__":
    # ========== é…ç½®åŒºåŸŸ ==========
    é…ç½® = ç‰¹å¾å·¥ç¨‹é…ç½®()#ä½¿ç”¨Embeddedï¼Œpcaï¼Œè¾“å‡ºç‰¹å¾ä¸º10
    # ========== æ•°æ®åŠ è½½ ==========
    æ–‡ä»¶è·¯å¾„ = r'D:\åº”ç”¨æ•°æ®\onedive\OneDrive\Desktop\1\DryBeanDataset\DryBeanDataset\Dry_Bean_Dataset.xlsx'

    try:
        print(f" åŠ è½½æ•°æ®: {æ–‡ä»¶è·¯å¾„}")
        æ•°æ®æ¡† = pd.read_excel(æ–‡ä»¶è·¯å¾„)

        # åˆ†ç¦»ç‰¹å¾å’Œæ ‡ç­¾
        åŸå§‹ç‰¹å¾ = æ•°æ®æ¡†.iloc[:, :-1].values.astype(float)
        æ ‡ç­¾ = æ•°æ®æ¡†.iloc[:, -1].values
        ç‰¹å¾åç§° = æ•°æ®æ¡†.columns[:-1].tolist()

        print(f"  åŸå§‹æ•°æ®é›†ç»´åº¦: {åŸå§‹ç‰¹å¾.shape}")
        print(f"  ç‰¹å¾æ•°é‡: {len(ç‰¹å¾åç§°)}")
        print(f"  æ ·æœ¬æ•°é‡: {len(æ ‡ç­¾)}")

        # ========== æ‰§è¡Œç‰¹å¾å·¥ç¨‹ ==========
        å¤„ç†åç‰¹å¾, ç‰¹å¾æ©ç  = æ‰§è¡Œç‰¹å¾å·¥ç¨‹(åŸå§‹ç‰¹å¾, æ ‡ç­¾, é…ç½®)

        # ========== ä¿å­˜ç»“æœ ==========
        ä¿å­˜å¤„ç†ç»“æœ(å¤„ç†åç‰¹å¾, æ ‡ç­¾, ç‰¹å¾åç§°, é…ç½®.è¾“å‡ºæ–‡ä»¶è·¯å¾„)

        # ========== è¾“å‡ºç‰¹å¾æŠ¥å‘Š ==========
        print("\nğŸ” ç‰¹å¾å·¥ç¨‹æŠ¥å‘Š:")#hasattr()æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨äºæ£€æŸ¥å¯¹è±¡æ˜¯å¦å…·æœ‰æŒ‡å®šçš„å±æ€§æˆ–æ–¹æ³•
        if hasattr(é…ç½®, 'ç‰¹å¾é€‰æ‹©æ–¹æ³•') and é…ç½®.ç‰¹å¾é€‰æ‹©æ–¹æ³• != 'none':
            é€‰ä¸­ç‰¹å¾æ•° = np.sum(ç‰¹å¾æ©ç )
            print(f"  ç‰¹å¾é€‰æ‹©: ä» {len(ç‰¹å¾æ©ç )} ä¸ªç‰¹å¾ä¸­é€‰ä¸­ {é€‰ä¸­ç‰¹å¾æ•°} ä¸ªå…³é”®ç‰¹å¾")

        if hasattr(é…ç½®, 'ç‰¹å¾æå–æ–¹æ³•') and é…ç½®.ç‰¹å¾æå–æ–¹æ³•:
            print(f"  ç‰¹å¾æå–: ä½¿ç”¨{é…ç½®.ç‰¹å¾æå–æ–¹æ³•.upper()}ç”Ÿæˆæ–°ç‰¹å¾ç©ºé—´")

        print(f"  æœ€ç»ˆç‰¹å¾ç»´åº¦: {å¤„ç†åç‰¹å¾.shape[1]}")

    except Exception as e:
        print(f"âŒ æ•°æ®å¤„ç†é”™è¯¯: {str(e)}")
        import traceback

        traceback.print_exc()